<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <script>
        var MP = (function () {
            let PENDING = 'PENDING';
            let FULFILLED = 'FULFILLED';
            let REJECTED = 'REJECTED';

            function isFun(fn) {
                return typeof fn == 'function'
            }

            let _MP = function (syncFn) {
                this.status = PENDING;
                // ç”¨æˆ·å®šä¹‰çš„æˆåŠŸã€å¤±è´¥å›è°ƒå‡½æ•°ï¼Œæ”¾åœ¨defersé‡Œé¢çš„ï¼Œç­‰å¼‚æ­¥ç»“æŸæ‰è°ƒç”¨
                this.defers = [];
                // è°ƒç”¨new Promiseå°±ä¼šå…ˆæ‰§è¡ŒsyncFnï¼Œå¼€å§‹è¿›è¡Œå¼‚æ­¥å¤„ç†
                // setTimeout ç¡®ä¿äº†thenæ–¹æ³•è¢«å…ˆæ‰§è¡Œï¼ŒsyncFnçš„è°ƒç”¨è¢«æ”¾åˆ°äº†å¼‚æ­¥é˜Ÿåˆ—ä¼šåæ‰§è¡Œ
                setTimeout(syncFn.bind(null, this.onResolve.bind(this), this.onRejected.bind(this)), 0);
                // onResolve/onRejected æ˜¯ç”¨æˆ·æ¥è°ƒç”¨ï¼Œä¸æ˜¯promiseå†…éƒ¨è°ƒç”¨çš„
                // onResolve/onRejected ä¸æ˜¯å…¨ç­‰äº then å‡½æ•°ä¼ è¿›æ¥çš„å‡½æ•°
                // è°ƒç”¨resolve/rejectedï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯promiseå†…éƒ¨çš„onResolve/onRejectedï¼Œæ›´åƒæ˜¯ä¸€ä¸ªä»£ç†
            }
            _MP.resolve = function (data) {
                return new _MP((resolve)=>{resolve(data)})
            }

            _MP.prototype = {
                constructor: _MP,
                then: function (resolve, rejected) {
                    // å°†resolve, rejectedå‡½æ•°ã€æ³¨å†Œã€‘åˆ°defersä¸­ç­‰å¾…å¼‚æ­¥æ‰§è¡ŒæˆåŠŸåè°ƒç”¨
                    var o = {
                        resolve,
                        rejected,
                        mp: new _MP(()=>{}), // è¿™é‡Œå¿…é¡»æ˜¯ä¸€ä¸ªæ°¸è¿œä¸ä¼šè¢«resolveçš„promise
                        // å› ä¸ºè¿™ä¸ªpromiseä¸éœ€è¦è¢«resolveï¼Œå¯¹åº”çš„æ“ä½œè¢«ä¸‹é¢æåˆ°çš„nextWPä»£æ›¿äº†
                    }
                    if (this.status == PENDING) {
                        this.defers.push(o);
                    } else {
                        this.handle(o);
                    }
                    return o.mp
                },
                onResolve: function (data) {
                    if (this.status == FULFILLED) return; // é¿å…ç”¨æˆ·å¤šæ¬¡è°ƒç”¨resolve
                    this.status = FULFILLED;
                    this.data = data;
                    this.done(this.defers);
                },
                onRejected: function (data) {
                    if (this.status == REJECTED) return; // é¿å…ç”¨æˆ·å¤šæ¬¡è°ƒç”¨rejected
                    this.status = REJECTED;
                    this.data = data;
                    this.done(this.defers);
                },
                done: function (defers) {
                    if (this.status != PENDING) defers.forEach(o => this.handle(o));
                },
                handle: function (o) {
                    let {resolve, rejected} = o;
                    let nextMP;
                    switch (this.status) {
                        case FULFILLED: {
                            if (!isFun(resolve)) throw new Error('no resolve');
                            nextMP = resolve(this.data);
                        }
                            break;
                        case REJECTED: {
                            if (!isFun(rejected)) throw new Error('no rejected');
                            nextMP = rejected(this.data);
                        }
                            break;
                        default: break;
                    }
                    // nextMPæœ€ç»ˆä¼šæ˜¯ä¸ªpromiseï¼Œé‚£æ€ä¹ˆå’Œthenè¿”å›çš„é‚£ä¸ªç©ºçš„promiseäº§ç”Ÿè”ç³»ï¼Œå¥½è®©ä¸‹ä¸ªthenæ¥é“¾å¼å‘¢???
                    // ä¸‹ä¸€ä¸ªthençš„çœŸæ­£çš„å®¿ä¸»æ˜¯é‚£ä¸ªo.mpï¼Œå®ƒçš„defersæ‰æ˜¯è£…çš„ä¸‹æ¬¡resolve/rejectedçš„å›è°ƒ
                    // ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œthenæ–¹æ³•åº”è¯¥æ—©å·²è¿”å›äº†o.mpï¼Œæ€ä¹ˆåŠï¼Œ
                    // æ€ä¹ˆæŠŠæ–°çš„promiseçš„æ•°æ®ä¼ ç»™å·²ç»è¿”å›å‡ºå»çš„å¯¹è±¡???
                    // åˆæ€ä¹ˆæŠŠè¿”å‡ºå»çš„é‚£ä¸ªpromsieçš„defersæ‹¿è¿‡æ¥æ¥æ”¶è¿™ä¸ªæ•°æ®???
                    // æ›¿æ¢ç»™ä¹‹å‰è¿”å›å‡ºå»çš„é‚£ä¸ªpromiseçš„deferså°±èƒ½è”ç³»ä¸Šäº†ã€è¿™é‡Œå†ä½“ä¼šä¸‹ã€‘
                    // nextMPè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š
                    //  1. nextMPä¸ºpromiseï¼Œå®ƒæœ‰è‡ªå·±çš„syncFnä¼šåœ¨å¼‚æ­¥æˆåŠŸ(æœ€å¿«æ˜¯ä¸‹æ¬¡äº‹ä»¶å¾ªç¯)æ—¶è°ƒç”¨resolve
                    //     è¿™é‡Œå¾—æå‰æ›¿æ¢æ›¿æ¢defersï¼Œä»¥å¤‡thenæ‰§è¡Œæ—¶å°†resolve/rejectedæ·»åŠ ç»™nextMP.defersï¼Œé‚£å€¼æ€ä¹ˆ???
                    //  2. nextMPä¸ºépromiseï¼Œå°è£…æˆpromiseï¼Œè°ƒç”¨resolveå›è°ƒï¼Œä¼ å…¥å€¼å°±è¡Œ
                    // ä¸Šé¢è¯´äº†ï¼šå€¼æ€ä¹ˆ???
                    // nextMPå®ƒåªæ˜¯ä¸ºäº†åœ¨å¼‚æ­¥æˆåŠŸåæ‰§è¡ŒsyncFnå‡½æ•°'(resolve)=>{resolve(data)}'è€Œå·²ï¼Œä»è€Œæ‰§è¡Œäº†å®ƒçš„onResolveæ¥æ”¶åˆ°äº†data
                    // ç„¶è€ŒnextMPçš„thenæ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±çš„defersé‡Œé¢æ²¡å¾—resolve/rejectedå‡½æ•°
                    // é‚£å°±"å·å–"ä¹‹å‰è¿”å›çš„é‚£ä¸ªo.mpçš„defersğŸ˜‚å°±èƒ½è¾¾åˆ°ç›®çš„äº†
                    // å½“nextMPåœ¨å¼‚æ­¥æˆåŠŸåè°ƒç”¨onResolveæ—¶ï¼Œæœ‰äº†è‡ªå·±çš„dataä¹Ÿæœ‰äº†"å·"æ¥çš„defersï¼Œå°±æ‰§è¡Œdone
                    // ç»“æœå‘¢ï¼Œdefersè£…çš„æ˜¯è¿”å›çš„é‚£ä¸ªo.mpçš„thenæ³¨å†Œçš„å›è°ƒï¼Œå®Œç¾æ”¶å…³ğŸ»
                    if (!(nextMP instanceof _MP)) {
                        let data = nextMP;
                        nextMP = _MP.resolve(data);
                    }
                    nextMP.defers = o.mp.defers;
                },
            };
            return _MP;
        })();

        var o = new MP(function (resolve) {
            // åªä»¥ç¬¬ä¸€æ¬¡çš„ä¸ºå‡†
            setTimeout(() => {
                resolve('å“ˆå“ˆï¼Œç¬¬ä¸€æ¬¡å¼‚æ­¥æ•°æ®æœ‰äº†ï¼--setTimeout');
            }, 100);
            resolve('å“ˆå“ˆï¼Œç¬¬ä¸€æ¬¡å¼‚æ­¥æ•°æ®æœ‰äº†ï¼');
        });
        o.then(function (data) {
            console.log('ç¬¬ä¸€ä¸ªpromseï¼š', data);
            return new MP(function (resolve, rejected) {
                setTimeout(() => {
                    rejected('å‘µå‘µï¼Œç¬¬äºŒæ¬¡å¼‚æ­¥çš„é”™è¯¯æ•°æ®ï¼');
                }, 500);
            });
        })
        .then(null, function (data) {
            console.log('ç¬¬äºŒä¸ªpromseï¼š', data);
            return 'è¿™ä¸æ˜¯promiseï¼Œå˜¿å˜¿ï¼';
            // å†æ¬¡å¼ºè°ƒä¸‹ï¼šè¿™ä¸ªreturnæ˜¯rsolveçš„ï¼Œä¸æ˜¯thenæ–¹æ³•çš„ã€‚ã€‚ã€‚è¿™ä¸ªå€¼èµ‹ç»™äº†pçš„
        })
        .then(function (data) {
            console.log('ç¬¬ä¸‰ä¸ªï¼š', data);
        });

        // å¯å‘ï¼š
        // returnçš„é‚£ä¸ªå€¼åœ¨ä¸‹ä¸ªå‡½æ•°ä¸­è°ƒç”¨ï¼Œå¯ä»¥è¿™æ ·æ¥å°è£…
        // 
    </script>
</body>

</html>